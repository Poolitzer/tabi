function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function formatDate(e,t){return new Date(e).toLocaleDateString(t,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function emojify(o,e){return e&&0!==e.length&&e.forEach(e=>{var t=escapeHtml(e.url),a=escapeHtml(e.shortcode),e=escapeRegex(e.shortcode),e=new RegExp(`:${e}:`,"g");o=o.replace(e,`<img src="${t}" alt="${a}" class="emoji" loading="lazy" />`)}),o}function renderComment(e,t){var a=escapeHtml(e.account.display_name||e.account.username),o=escapeHtml(e.account.username),n=escapeHtml(e.account.url),r=escapeHtml(e.account.avatar),s=emojify(e.content,e.emojis),t=formatDate(e.created_at,t),m=escapeHtml(e.url);let c="";return e.media_attachments&&0<e.media_attachments.length&&(c='<div class="mastodon-attachments">',e.media_attachments.forEach(e=>{var t=escapeHtml(e.url),a=escapeHtml(e.preview_url),o=escapeHtml(e.mime_type||"");"image"===e.type?c+=`<a href="${t}" target="_blank" rel="noopener noreferrer">
                    <img src="${a}" alt="${escapeHtml(e.description||"Image")}" loading="lazy" />
                </a>`:"video"===e.type||"gifv"===e.type?c+=`<video controls preload="metadata" poster="${a}">
                    <source src="${t}" type="${o||"video/mp4"}">
                </video>`:"audio"===e.type&&(c+=`<audio controls preload="metadata">
                    <source src="${t}" type="${o||"audio/mpeg"}">
                </audio>`)}),c+="</div>"),`
        <div class="mastodon-comment">
            <div class="mastodon-comment-header">
                <img src="${r}" alt="${a}'s avatar" class="mastodon-avatar" loading="lazy" />
                <div class="mastodon-author">
                    <a href="${n}" target="_blank" rel="noopener noreferrer" class="mastodon-author-name">
                        ${a}
                    </a>
                    <a href="${n}" target="_blank" rel="noopener noreferrer" class="mastodon-author-handle">
                        @${o}
                    </a>
                </div>
                <a href="${m}" target="_blank" rel="noopener noreferrer" class="mastodon-comment-date">
                    ${t}
                </a>
            </div>
            <div class="mastodon-comment-content">
                ${s}
            </div>
            ${c}
        </div>
    `}function renderComments(e,t){return e&&0!==e.length?e.map(e=>renderComment(e,t)).join(""):'<p class="mastodon-no-comments">No comments yet. Be the first to comment on Mastodon!</p>'}async function loadMastodonComments(e,t,a){var o=document.getElementById("mastodon-comments-list");try{if(!/^[a-z0-9]([a-z0-9-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9-]*[a-z0-9])?)*$/i.test(e))throw new Error("Invalid Mastodon host");if(!/^\d+$/.test(t))throw new Error("Invalid Mastodon post ID");var n=await fetch(`https://${encodeURIComponent(e)}/api/v1/statuses/${encodeURIComponent(t)}/context`);if(!n.ok)throw new Error("HTTP error! status: "+n.status);var r=(await n.json()).descendants||[];o.innerHTML=renderComments(r,a)}catch(e){console.error("Error loading Mastodon comments:",e),o.innerHTML='<p class="mastodon-error">Failed to load comments. Please try again later.</p>'}}function initMastodon(){var e,t,a,o,n=document.querySelector(".comments");n&&(e=n.getAttribute("data-mastodon-host"),t=n.getAttribute("data-mastodon-post-id"),a=n.getAttribute("data-page-language")||"en",o=n.getAttribute("data-mastodon-post-url"),e&&t?(o=o?escapeHtml(o):"",n.innerHTML=`
            <div class="mastodon-comments">
                <div class="mastodon-comments-header">
                    <h3>Comments</h3>
                    ${o?`<a href="${o}" target="_blank" rel="noopener noreferrer" class="mastodon-comment-link">Comment on Mastodon</a>`:""}
                </div>
                <div id="mastodon-comments-list">
                    <p class="mastodon-loading">Loading comments...</p>
                </div>
                ${o?`<p class="mastodon-reply-link"><a href="${o}" target="_blank" rel="noopener noreferrer" class="mastodon-comment-link">Reply on Mastodon</a></p>`:""}
            </div>
        `,loadMastodonComments(e,t,a)):console.error("Mastodon host or post ID not configured"))}initMastodon();
